---
title: '
<img src="logo.png" alt="Logo" width="400px" style="display:block; margin-left:auto; margin-right:0;" />
<br>
Analiza danych - kredyty hipoteczne
'
date: "`r Sys.Date()`"
authors: "Dominika Zapadka, Agata Witkowska, Mariusz Różek, Antoni Tomas"
output:
  rmarkdown::html_document:
    highlight: kate
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    fig_width: 6
    fig_height: 4
    self_contained: true
    theme: readable
---

```{r setup, include=FALSE}
## Global options
if (!require("naniar")) install.packages("naniar")
if (!require("Amelia")) install.packages("Amelia")
if (!require("mice")) install.packages("mice")
if (!require("finalfit")) install.packages("finalfit")
if(!require("VIM")) install.packages("VIM")
if(!require("validate")) install.packages("validate")
if(!require("knitr")) install.packages("knitr")
if(!require("kableExtra")) install.packages("kableExtra")
if(!require("ggplot2")) install.packages("ggplot2")
if(!require("patchwork")) install.packages("patchwork")
library(finalfit)
library(Amelia)
library(mice)
library(readr)
library(dplyr)
library(naniar)
library(knitr)
library(kableExtra)
library(ggplot2)
library(patchwork)
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
dane <- read_csv("Hipoteczny.csv")
```

```{=html}
<style>
body {
  background-color: #e6f0ff;
}
</style>
```

# **Wstęp**

## Opis problemu

<p style="text-align: justify;">Celem projektu jest przeprowadzenie analizy danych dotyczących zatwierdzenia kredytu mieszkaniowego i określenie, które czynniki w największym stopniu wpływają na decyzję o przyznaniu pożyczki. Firma, której dane analizujemy obsługuje klientów z obszarów miejskich, półmiejskich i wiejskich, a proces wnioskowania odbywa się za pomocą wypełnienia formularza online przez klienta. Aby przyspieszyć podejmowanie decyzji i zwiększyć efektywność obsługi, przedsiębiorstwo planuje automatyzację procesu oceny zdolności kredytowej w czasie rzeczywistym.</p>

## Dane

Do analizy wykorzystano zbiór danych: [Hipoteczny.csv](https://github.com/antonitomas/Projekt---kredyty-hipoteczne/blob/main/Hipoteczny.csv){style="color:navy"}.

<p style="text-align: justify;">Obejmuje on 614 obserwacji. Dane pochodzą z procesu składania wniosków kredytowych i zawierają informacje o wnioskodawcy i charakterystyce pożyczki. Wśród dostępnych kolumn znajdują się między innymi:</p>

-   **Loan_ID:** identyfikator wniosku,
-   **Gender:** płeć wnioskodawcy,
-   **Married:** informacja o stanie cywilnym,
-   **Dependents:** liczba osób na utrzymaniu,
-   **Education:** poziom wykształcenia,
-   **Self_Employed:** prowadzenie działalności gospodarczej,
-   **ApplicantIncome i CoapplicantIncome:** dochody głównego i współwnioskodawcy,
-   **LoanAmount:** kwota pożyczki,
-   **Loan_Amount_Term:** okres kredytowania,
-   **Credit_history:** informacja o historii kredytowej,
-   **Property_Area:** obszar pochodzenia klienta,
-   **Loan_Status:** wynik decyzji kredytowej (zatwierdzony lub odrzucony).

<p style="text-align: justify;">Zbiór danych nie jest kompletny i część kolumn zawiera braki. Najwięcej braków występuje w zmiennych **Credit_History, LoanAmount, Loan_Amount_Term, Self_Employed, Dependents** oraz częściowo w **Gender** i **Married**. Wstępny przegląd danych pokazuje, że tylko zmienne takie jak dochód czy identyfikator wniosku są pełne, a elementy oceny ryzyka kredytowego wymagają dalszego uzupełnienia.</p>

## Przebieg analizy

<p style="text-align: justify;">Projekt koncentruje się na zrozumieniu, które cechy klientów najsilniej wiążą się z przyznaniem lub odrzuceniem kredytu i przygotowaniu modelu, który mógłby automatycznie wskazywać potencjalnie kwalifikujących się wnioskdawców. Wykonamy wstępne oczyszczanie danych, eksplorację, wizualizację i przeprowadzimy analizę jedno oraz dwuwymiarową. Wnioski z analizy pomogą usprawnić proces oceny wniosków kredytowych oraz poprawić skuteczność i spójność decyzji podejmowanych przez firmę.</p>

# **Przygotowanie danych**

## Braki danych

```{r wczytanie danych, message=FALSE, warning=FALSE, include=FALSE}
kredyty <- as.data.frame(dane)
View(kredyty)
```

```{r podsumowanie braków danych, message=FALSE, warning=FALSE}
liczba_brakow <- miss_var_summary(kredyty)
tabela1 <- head(liczba_brakow,3)
colnames(tabela1) <- c("Nazwa zmiennej", "Liczba braków", "Udział braków")

kable(tabela1, align = "c") %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  row_spec(0, bold = TRUE, color = "navy")
```

<p style="text-align: justify;">Największą liczbę brakujących danych zawierają kolejno zmienne:
<span style="color:navy;">Credit_History</span> (50 braków danych),
<span style="color:navy;">Self_Employed</span> (32 braki danych) oraz
<span style="color:navy;">LoanAmount</span> (22 braki danych).</p>

<p style="text-align: center;"><span style="color:navy;">**Braki danych według liczby osób na utrzymaniu**</span></p>

```{r wizualizacja braków danych 1, message=FALSE, warning=FALSE, fig.align='center', fig.width=7, fig.height=5}
gg_miss_fct(kredyty, Dependents) +
  labs(title = "",
       x = "Liczba osób na utrzymaniu",
       y = "Zmienne",
       fill = "Procent braków") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5)) +
  scale_fill_gradient(low="lavender", high="navy")
```

<p style="text-align: justify;">Na podstawie heatmapy można stwierdzić nielosowość brakujących danych. Widać to na podstawie dużego natężenia braków danych w zmiennej określającej stan cywilny klienta (<span style="color:navy;">Married</span>), w sytuacji gdy nie podał on również liczby osób na swoim utrzymaniu (<span style="color:navy;">Dependents</span>).</p>

```{r wizualizacja braków danych 2, message=FALSE, warning=FALSE, include=FALSE}
gg_miss_upset(kredyty)
```

<p style="text-align: center;"><span style="color:navy;">**Mapa braków danych**</span></p>

```{r wizualizacja braków danych 3, message=FALSE, warning=FALSE, fig.align='center', fig.width=7, fig.height=5}
missmap(kredyty,
        main = "",
        col = c("lavender", "midnightblue"))
```

```{r wizualizacja braków danych 4, message=FALSE, warning=FALSE, fig.align='center', fig.width=7, fig.height=5}
invisible(md.pattern(kredyty, rotate.names = TRUE))
```

<p style="text-align: justify;">Dane zawierają 2% braków danych (<span style="color:navy;">missmap</span>), a braki te nie są zależne między sobą (<span style="color:navy;">md.pattern</span>). W celu zastąpienia braków danych można wykorzystać proste metody: mediana, średnia, dominanta lub użyć funkcji hotdeck.</p>

## Zastępowanie braków danych

<p style="text-align: justify;"><span style="color:navy;">**Hotdeck**</span> - metoda polegająca na zastępowaniu braków danych według wierszy najczęściej się powtarzających (najbardziej prawdopodobny)</p>

```{r zastępowanie braków danych, message=FALSE, warning=FALSE}
library(VIM)
kredyty_inp <- hotdeck(kredyty)
vis_miss(kredyty_inp, sort_miss = TRUE)
```

## Reguły zmiennych

Nadano reguły dla zmiennych w celu sprawdzenia poprawności danych po uzupełnieniu braków. Stworzono wykres, który sprawdza, czy dane spełniają ustalone reguły.

```{r reguły zmiennych}
#ustalanie reguł dla zmiennych
library(validate) 
rules <- validator (
  Dependents >=0,
  Gender %in% c("Male","Female"),
  Married %in% c("Yes","No"),
  Education %in% c("Graduate","Not Graduate"),
  Self_Employed %in% c("Yes","No"),
  Applicantincome >=0,
  Coapplicantincome >=0,
  LoanAmount >=0,
  Loan_Amount_Term >=0,
  Loan_Amount_Term %% 6 == 0,
  Property_Area %in% c("Urban","Semiurban","Rural"),
  Loan_Status %in% c("Y","N"),
  Credit_history %in% c(0,1)
)
cf <- confront(kredyty_inp, rules, key="Loan_ID")
summary(cf)
barplot(cf, main="kredyty_inp")
#as.data.frame(cf) %>% head()
```

## Duplikaty
Dane nie posiadają duplikatów, obserwacje są unikalne i nie ma potrzeby dodatkowego czyszczenia pod kątem prawidłowości struktury danych. 
```{r}
sum(duplicated(kredyty_inp))
```

# **Wizualizacja danych**

## Wykresy słupkowe

Czy miejsce zamieszkania wpływa na decyzję o przyznaniu kredytu?

<p style="text-align: center;"><span style="color:navy;">**Udział decyzji kredytowych w zależności od obszaru zamieszkania**</span></p>

```{r, fig.align='center', fig.width=7, fig.height=5}
ggplot(kredyty_inp, aes(x = Property_Area, fill = Loan_Status)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
       x = "Obszar zamieszkania",
       y = "Udział (%)",
       fill = "Decyzja") +
  scale_fill_manual(values = c("N" = "lavender", "Y" = "navy")) +
  theme_minimal(base_size = 10)
```

<p style="text-align: justify;">Najwyższy odsetek wniosków zakończonych przyznaniem kredytu można zaobserwować wśród klientów mieszkających w obszarach półmiejskich. W tej grupie ponad 75% wniosków kończy się akceptacją. W obszarach miejskich i wiejskich udział decyzji pozytywnych jest niższy i wynosi około 60-65%.</p>

<p style="text-align: center;"><span style="color:navy;">**Udział decyzji kredytowych w zależności od historii kredytowej**</span></p>

```{r, fig.align='center', fig.width=7, fig.height=5}
ggplot(kredyty_inp, aes(x = as.factor(Credit_History), fill = Loan_Status)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Historia kredytowa (0 = brak, 1 = dobra)",
    y = "Udział (%)",
    fill = "Decyzja"
  ) +
  scale_fill_manual(values = c("N" = "lavender", "Y" = "navy")) +
  theme_minimal(base_size = 10)
```

<p style="text-align: justify;">Wykres pokazuje, że wśród klientów posiadających historię kredytową znaczna większość otrzymuje kredyt, natomiast jej brak wiąże się z dużo większym odsetkiem odrzuceń.</p>

<p style="text-align: center;"><span style="color:navy;">**Udział decyzji kredytowych w zależności od poziomu wykształcenia**</span></p>

```{r, fig.align='center', fig.width=7, fig.height=5}
ggplot(kredyty_inp, aes(x = as.factor(Education), fill = Loan_Status)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Poziom wykształcenia",
    y = "Udział (%)",
    fill = "Decyzja"
  ) +
  scale_fill_manual(values = c("N" = "lavender", "Y" = "navy")) +
  theme_minimal(base_size = 10) +
  theme(plot.title = element_text(hjust = 0.5))
```

## Wykresy pudełkowe

```{r, fig.align='center', fig.width=7, fig.height=8}
p1 <- ggplot(kredyty_inp, aes(x = Education, y = LoanAmount)) +
  geom_boxplot(color = "navy") +
  labs(
    x = "Poziom wykształcenia",
    y = "Kwota pożyczki [tys. USD]"
  ) +
  theme(plot.margin = margin(5,5,5,5)) +
  theme_minimal()

p2 <- ggplot(kredyty_inp, aes(x = Gender, y = LoanAmount)) +
  geom_boxplot(color = "navy") +
  labs(
    x = "Płeć",
    y = "Kwota pożyczki [tys. USD]"
  ) +
  theme(plot.margin = margin(5,5,5,5)) +
  theme_minimal()

p3 <- ggplot(kredyty_inp, aes(x = as.factor(Credit_History), y = LoanAmount)) +
  geom_boxplot(color = "navy") +
  labs(
    x = "Historia kredytowa (0 = brak, 1 = dobra)",
    y = "Kwota pożyczki [tys. USD]"
  ) +
  theme(plot.margin = margin(20,5,5,5)) +
  theme_minimal()

p4 <- ggplot(kredyty_inp, aes(x = Property_Area, y = LoanAmount)) +
  geom_boxplot(color = "navy") +
  labs(
    x = "Obszar zamieszkania",
    y = "Kwota pożyczki [tys. USD]"
  ) +
  theme(plot.margin = margin(20,5,5,5)) +
  theme_minimal()

p5 <- ggplot(kredyty_inp, aes(x = Dependents, y = LoanAmount)) +
  geom_boxplot(color = "navy") +
  labs(
    x = "Liczba osób w gospodarstwie",
    y = "Kwota pożyczki [tys. USD]"
  ) +
  theme(plot.margin = margin(20,5,5,5)) +
  theme_minimal()

p6 <- ggplot(kredyty_inp, aes(x = Married, y = LoanAmount)) +
  geom_boxplot(color = "navy") +
  labs(
    x = "Związek małżeński",
    y = "Kwota pożyczki [tys. USD]"
  ) +
  theme(plot.margin = margin(20,5,5,5)) +
  theme_minimal()

(p1 + p2) /
(p3 + p4) /
(p5 + p6) +
  plot_layout(heights = c(1, 1, 1))

```

## Heatmapa

<p style="text-align: center;"><span style="color:navy;">**Korelacja zmiennych numerycznych**</span></p>

```{r, fig.align='center', fig.width=7, fig.height=5}
macierz_korelacji <- round(cor(kredyty_inp %>% select_if(is.numeric)), 2)
macierz_korelacji <- reshape2::melt(macierz_korelacji)

nazwy <- c(
  ApplicantIncome = "Dochód wnioskodawcy",
  CoapplicantIncome = "Dochód współwnioskodawcy",
  LoanAmount = "Kwota pożyczki",
  Loan_Amount_Term = "Okres pożyczki",
  Credit_History = "Historia kredytowa"
)

ggplot(data = macierz_korelacji, aes(x = Var1, y = Var2, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradient2(
        low = "orchid",
        high = "navy",
        mid = "lavender",
        midpoint = 0,
        limit = c(-1, 1),
        space = "Lab",
        name = "Korelacja"
    ) +
    theme_minimal() +
    coord_fixed() +
    geom_text(aes(Var1, Var2, label = round(value, 2)), color = "black", size = 4) +
    labs(
        x = "",
        y = ""
    ) +
    scale_x_discrete(labels = nazwy) +
    scale_y_discrete(labels = nazwy) +
    theme(
        axis.text.x = element_text(angle = 90, vjust = 1, size = 10, hjust = 1),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(hjust = 0.5)
    )

```

## Wykres punktowy

<p style="text-align: center;"><span style="color:navy;">**Zależność między dochodem wnioskodawcy a kwotą pożyczki**</span></p>

```{r, fig.align='center', fig.width=7, fig.height=5}
filtered_data <- kredyty_inp %>%
    mutate(Income = (ApplicantIncome + CoapplicantIncome)/1000)
ggplot(data = filtered_data, aes(x = Income, y = LoanAmount, color = Loan_Status)) +
    geom_point(alpha = 0.7, size = 3) + 
    labs(
        x = "Dochód gospodarstwa domowego [tys. USD]",
        y = "Kwota pożyczki [tys. USD]",
        color = "Status pożyczki"
    ) +
    scale_color_manual(values = c("N" = "orchid", "Y" = "navy")) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))

```

<p style="text-align: justify;">Zdecydowana większość wniosków kredytowych koncentruje się w obszarze niskich dochodów - poniżej 20 000 USD oraz niskich kwot pożyczek, czyli tych o kwotach poniżej 300 tys. USD. Powyższy wykres wskazuje zatem, że dochód i kwota pożyczki nie są jedynymi czynnikami decyzyjnymi, ponieważ w określonym obszarze występują zarówno wnioski przyjęte, jak i odrzucone.</p>

## Wykres kołowy

<p style="text-align: center;"><span style="color:navy;">**Rozkład statusów decyzji kredytowych**</span></p>

```{r, fig.align='center', fig.width=7, fig.height=5}
max_income <- 20000
max_loan_amount <- 300

filtered_data <- kredyty_inp %>%
    filter(ApplicantIncome <= max_income) %>%
    filter(LoanAmount <= max_loan_amount)

counts_summary <- filtered_data %>%
    count(Loan_Status)

kolowy <- data.frame(
  Loan_Status = c("N", "Y"),
  n = c(177, 401)
)

kolowy2 <- kolowy %>%
  mutate(
    total = sum(n),
    percentage = (n / total) * 100
  )

ggplot(kolowy2, aes(x = "", y = percentage, fill = Loan_Status)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) + 
  scale_fill_manual(values = c("N" = "orchid", "Y" = "navy")) + 
  theme_void() + 
  labs(fill = "Status pożyczki") +
  geom_text(
    aes(label = paste0(round(percentage, 1), "%\n(", n, ")")),
    position = position_stack(vjust = 0.5),
    color = "lavender",
    size = 5
  ) +
  theme(
    legend.position = "right"
  )

# albo w ggpie
```

